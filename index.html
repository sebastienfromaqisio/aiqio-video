<!doctype html>
<html lang="fr">
<head>
  <!-- ===== Base minimaliste & perf ===== -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>LP — Vidéo Personnalisée</title>
  <!-- Pré-connexion utiles -->
  <link rel="preconnect" href="https://iframe.videodelivery.net" crossorigin>
  <link rel="preconnect" href="https://script.google.com" crossorigin>
  <style>
    /* ===== Styles ultra-simples pour lisibilité ===== */
    :root { --fg:#111; --muted:#666; --bg:#fff; --err:#b00020; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:760px;margin:24px auto;padding:0 16px}
    h1{font-size:20px;margin:0 0 8px}
    .meta,.debug{font-size:14px;color:var(--muted)}
    .video{margin:16px 0;aspect-ratio:16/9;background:#000}
    iframe{width:100%;height:100%;border:0;display:block}
    .error{color:var(--err);font-weight:600;margin-top:12px}
    .kv{margin:4px 0}
    .kv code{background:#f4f4f4;padding:2px 4px;border-radius:4px}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- ===== Qu'est-ce qui est quoi ===== -->
    <h1>LP — Vidéo personnalisée du prospect</h1>
    <p class="meta">Cette page lit <code>f</code> (prénom), <code>l</code> (nom), <code>id</code> (UID vidéo Cloudflare Stream), <code>d</code> (date) depuis l’URL.</p>

    <!-- ===== Infos visibles pour debug ===== -->
    <div id="info" class="debug">
      <div class="kv">Prénom (<code>f</code>) : <strong id="fVal">—</strong></div>
      <div class="kv">Nom (<code>l</code>) : <strong id="lVal">—</strong></div>
      <div class="kv">Date (<code>d</code>) : <strong id="dVal">—</strong></div>
      <div class="kv">ID vidéo (<code>id</code>) : <strong id="idVal">—</strong></div>
    </div>

    <!-- ===== Emplacement vidéo ===== -->
    <div id="videoBox" class="video hidden" aria-label="Lecteur vidéo Cloudflare Stream"></div>

    <!-- ===== Erreurs lisibles ===== -->
    <div id="errorBox" class="error hidden"></div>

    <noscript><p class="error">JavaScript est requis pour charger la vidéo et enregistrer la visite.</p></noscript>
  </div>

  <script>
    // ====== 0) Lecture des paramètres d'URL (f, l, id, d) ======
    const qs = new URLSearchParams(location.search);
    const raw = {
      f: qs.get('f') || '',
      l: qs.get('l') || '',
      id: qs.get('id') || '',
      d: qs.get('d') || ''
    };

    // Affichage "qu'est-ce qui est quoi"
    const setText = (id, v) => document.getElementById(id).textContent = v || '—';
    setText('fVal', raw.f);
    setText('lVal', raw.l);
    setText('dVal', raw.d);
    setText('idVal', raw.id);

    // ====== 1) Affichage vidéo Cloudflare Stream (si id présent) ======
    const errorBox = document.getElementById('errorBox');
    const showError = (msg) => { errorBox.textContent = msg; errorBox.classList.remove('hidden'); };

    if (!raw.id) {
      showError('Paramètre manquant : id (UID vidéo Cloudflare Stream).');
    } else {
      const src = 'https://iframe.videodelivery.net/' + encodeURIComponent(raw.id) + '?autoplay=true&muted=true&controls=true';
      const iframe = document.createElement('iframe');
      iframe.setAttribute('allow','accelerometer; gyroscope; autoplay; encrypted-media; picture-in-picture; clipboard-write');
      iframe.setAttribute('allowfullscreen','');
      iframe.src = src;
      const box = document.getElementById('videoBox');
      box.appendChild(iframe);
      box.classList.remove('hidden');
    }

    // (Confort) Titre personnalisé si on a f/l
    if (raw.f || raw.l) document.title = 'Vidéo pour ' + [raw.f, raw.l].filter(Boolean).join(' ');

    // ====== 2) Tracking "VISITE" → Google Apps Script → Google Sheets ======
    (function(){
      // Ce qui est envoyé :
      const visit = {
        ts_client: new Date().toISOString(),   // timestamp navigateur (informatif)
        url: location.href,                    // URL complète visitée
        referrer: document.referrer || '',     // provenance
        ua: navigator.userAgent || '',         // user-agent
        viewport_w: window.innerWidth || 0,    // largeur viewport
        viewport_h: window.innerHeight || 0,   // hauteur viewport
        lang: navigator.language || '',        // langue navigateur
        // Valeurs "prospect + vidéo" en clair comme demandé
        f: raw.f,
        l: raw.l,
        id: raw.id,
        d: raw.d
      };

      // URL de déploiement Apps Script (fournie)
      const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzESR1YDhQKMSUcJA8akPoztJSQnJTuHePArj-VXdLO2MM4b3qjcNJSqjSbKBoVBD44vg/exec';

      // Prépare le payload
      const payload = new Blob([JSON.stringify(visit)], { type: 'application/json' });

      // Envoi principal : sendBeacon (léger, non-bloquant)
      let sent = false;
      if (navigator.sendBeacon) {
        sent = navigator.sendBeacon(WEB_APP_URL, payload);
      }

      // Fallback si sendBeacon indisponible
      if (!sent) {
        try {
          fetch(WEB_APP_URL, {
            method: 'POST',
            body: JSON.stringify(visit),
            headers: { 'Content-Type': 'application/json' },
            keepalive: true,
            mode: 'no-cors'
          });
        } catch(_) { /* on garde la page ultra-légère */ }
      }

      // Ping de sortie minimal (optionnel) pour capter les visites très courtes
      addEventListener('visibilitychange', function(){
        if (document.visibilityState === 'hidden' && navigator.sendBeacon) {
          const tiny = new Blob([JSON.stringify({
            url: visit.url, f: visit.f, l: visit.l, id: visit.id, d: visit.d,
            ts_client: new Date().toISOString(), final: true
          })], { type: 'application/json' });
          navigator.sendBeacon(WEB_APP_URL, tiny);
        }
      });
    })();
  </script>
</body>
</html>
