<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VidÃ©o de prospection Aqisio</title>
  <style>
    :root { color-scheme: dark; }
    body{ margin:0; background:#0b0b0b; color:#fff;
          font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
    .wrap{ display:grid; place-items:center; min-height:100dvh; padding:24px; }
    .player{ width:min(960px,100%); aspect-ratio:16/9; position:relative; }
    iframe{ width:100%; height:100%; border:0; border-radius:16px; }
    .note{ opacity:.7; margin-top:12px; font-size:.9rem; text-align:center; }

    /* Calendly inline (cachÃ© jusqu'Ã  la fin) */
    #calendly-block{
      display:none;
      width:min(960px,100%);
      margin:24px auto 32px;
      background:#111;
      border-radius:12px;
      padding:12px;
    }
    #calendly-title{
      margin:0 0 8px 0;
      font-size:1.1rem;
      opacity:.9;
      text-align:center;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="player">
      <!-- Cloudflare Stream : ta vidÃ©o -->
      <iframe id="stream-player"
        src="https://customer-g50chvgfq5q94nqo.cloudflarestream.com/5032da31754eb596edf1e9d68cbe031e/iframe?autoplay=true&muted=true"
        allow="autoplay; encrypted-media; picture-in-picture"
        allowfullscreen="true"></iframe>
    </div>

    <!-- Compteur / debug -->
    <p class="note" id="debug"></p>

    <!-- Calendly inline (apparaÃ®t automatiquement Ã  la fin) -->
    <section id="calendly-block">
      <h2 id="calendly-title">Merci dâ€™avoir regardÃ© ðŸ™Œ â€” RÃ©serve un crÃ©neau ci-dessous</h2>
      <div id="calendly-widget"
           class="calendly-inline-widget"
           data-url="https://calendly.com/aqisio/presentation?hide_event_type_details=1&hide_gdpr_banner=1"
           style="min-width:320px;height:700px;"></div>
    </section>
  </div>

  <!-- SDK Cloudflare Stream -->
  <script src="https://embed.cloudflarestream.com/embed/sdk.latest.js"></script>

  <script>
    /***** CONFIG *****/
    const WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbz9alEU_7igvcCej_rumzU7mtVQFYiCbUmczzNXpXVzU-1Uz37hHUhAe90z_I4Vstus/exec";
    const VIDEO_ID    = "5032da31754eb596edf1e9d68cbe031e";
    const qs          = new URLSearchParams(location.search);
    const prospectId  = qs.get("p") || "unknown";

    /***** Enrichissements (dÃ©jÃ  en place dans ta V2) *****/
    function parseUA(ua) {
      ua = ua || navigator.userAgent || '';
      let osName='Unknown', osVersion='', browserName='Unknown', browserVersion='', deviceType='desktop';
      if (/Windows NT/i.test(ua)){ osName='Windows'; const m=ua.match(/Windows NT ([\d\.]+)/i); osVersion=m?m[1]:''; }
      else if (/Mac OS X/i.test(ua) && !/like Mac OS X/.test(ua)){ osName='macOS'; const m=ua.match(/Mac OS X ([\d_]+)/i); osVersion=m?m[1].replace(/_/g,'.'):''; }
      else if (/iPhone|iPad|iPod/i.test(ua)){ osName='iOS'; const m=ua.match(/OS ([\d_]+) like Mac OS X/i); osVersion=m?m[1].replace(/_/g,'.'):''; }
      else if (/Android/i.test(ua)){ osName='Android'; const m=ua.match(/Android ([\d\.]+)/i); osVersion=m?m[1]:''; }
      else if (/Linux/i.test(ua)){ osName='Linux'; }
      if (/Edg\//.test(ua)){ browserName='Edge'; const m=ua.match(/Edg\/([\d\.]+)/); browserVersion=m?m[1]:''; }
      else if (/OPR\//.test(ua)){ browserName='Opera'; const m=ua.match(/OPR\/([\d\.]+)/); browserVersion=m?m[1]:''; }
      else if (/Chrome\//.test(ua) && !/Chromium/.test(ua)){ browserName='Chrome'; const m=ua.match(/Chrome\/([\d\.]+)/); browserVersion=m?m[1]:''; }
      else if (/Safari\//.test(ua) && /Version\//.test(ua) && !/Chrome|Chromium/.test(ua)){ browserName='Safari'; const m=ua.match(/Version\/([\d\.]+)/); browserVersion=m?m[1]:''; }
      else if (/Firefox\//.test(ua)){ browserName='Firefox'; const m=ua.match(/Firefox\/([\d\.]+)/); browserVersion=m?m[1]:''; }
      else if (/Chromium\//.test(ua)){ browserName='Chromium'; const m=ua.match(/Chromium\/([\d\.]+)/); browserVersion=m?m[1]:''; }
      if (/Tablet|iPad/i.test(ua)) deviceType='tablet';
      else if (/Mobile|iPhone|Android.*Mobile/i.test(ua)) deviceType='mobile';
      return { browserName, browserVersion, osName, osVersion, deviceType };
    }
    const language  = navigator.language || '';
    const timezone  = (Intl.DateTimeFormat().resolvedOptions().timeZone) || '';
    const screen_resolution = `${(window.screen && window.screen.width) || 0}x${(window.screen && window.screen.height) || 0}`;
    const ua = navigator.userAgent || '';
    const { browserName, browserVersion, osName, osVersion, deviceType } = parseUA(ua);

    /***** REPLAY COUNT (inchangÃ©) *****/
    function getReplayKey(pid){ return `aqisio:replay:${pid}`; }
    function getReplayCount(pid){ const v=Number(localStorage.getItem(getReplayKey(pid))||0); return isFinite(v)&&v>=0?v:0; }
    function incReplayCount(pid){ const v=getReplayCount(pid)+1; localStorage.setItem(getReplayKey(pid), String(v)); return v; }

    /***** Ã‰TAT DE SESSION *****/
    let sessionId, ended, duration, watchedMap, lastSecSent, isReplay, replayCount;
    function show(msg){ const el=document.getElementById("debug"); if(el) el.textContent=msg; }

    function newSession(markReplay=false) {
      sessionId   = (crypto.randomUUID && crypto.randomUUID()) || (Date.now()+"-"+Math.random());
      ended       = false;
      duration    = 0;
      watchedMap  = Object.create(null);
      lastSecSent = -1;
      if (markReplay){ isReplay=true; replayCount=incReplayCount(prospectId); }
      else { isReplay=false; if (getReplayCount(prospectId)===0) localStorage.setItem(getReplayKey(prospectId),'0'); replayCount=getReplayCount(prospectId); }
      show(`Session: ${sessionId} â€” replays: ${replayCount}${isReplay?' (replay)':''}`);
      // Masque Calendly si on relance aprÃ¨s un premier visionnage
      document.getElementById('calendly-block').style.display = 'none';
    }
    newSession(false);

    /***** PLAYER *****/
    const player = Stream(document.getElementById("stream-player"));
    player.play().catch(async () => { try { player.muted = true; await player.play(); } catch(_) {} });

    async function refreshDuration(){ try { duration = Math.floor(await player.duration); } catch(_) {} }
    refreshDuration(); setInterval(refreshDuration, 3000);

    /***** TRACKING (inchangÃ©) *****/
    setInterval(async () => {
      if (ended) return;
      try{
        const paused = await player.paused; if (paused) return;
        const t = await player.currentTime; const sec = Math.floor(t);
        if (!watchedMap[sec]){ watchedMap[sec]=true; if (sec!==lastSecSent){ lastSecSent=sec; sendSummary(false); } }
      }catch(_){}
    }, 1000);

    function computeSummary(){
      const secondsWatched = Object.keys(watchedMap).length;
      const percent = duration>0 ? Math.min(100, Math.round((secondsWatched/duration)*100)) : 0;
      return { secondsWatched, percent };
    }

    async function sendSummary(final=false){
      const { secondsWatched, percent } = computeSummary();
      show(`Session: ${sessionId} â€” ${secondsWatched}s / ${duration}s (${percent}%) â€” replays:${replayCount}${isReplay?' (replay)':''}` + (final ? " [final]" : ""));
      const payload = {
        prospectId, videoId: VIDEO_ID, secondsWatched, duration, percent,
        sessionId, userAgent: ua, final,
        language, timezone, screen_resolution,
        device_type: deviceType, browser_name: browserName, browser_version: browserVersion,
        os_name: osName, os_version: osVersion, is_replay: isReplay, replay_count: replayCount
      };
      try { await fetch(WEBHOOK_URL, { method:"POST", body: JSON.stringify(payload) }); } catch(e){}
    }

    /***** CALENDLY : apparition automatique Ã  la fin *****/
    let calendlyLoaded = false;
    function loadCalendlyScriptOnce(){
      if (calendlyLoaded) return;
      calendlyLoaded = true;
      const s = document.createElement('script');
      s.src = "https://assets.calendly.com/assets/external/widget.js";
      s.async = true;
      document.body.appendChild(s);
    }
    function showCalendly(){
      // charge le script si besoin, puis affiche le bloc
      loadCalendlyScriptOnce();
      const block = document.getElementById('calendly-block');
      block.style.display = 'block';
      // scroll doux pour mettre le widget en vue (mobile/desktop)
      block.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // Fin de vidÃ©o â†’ ping final, puis afficher Calendly
    player.addEventListener("ended", () => {
      if (ended) return;
      ended = true;
      sendSummary(true);
      showCalendly();
    });

    // Replay â†’ nouvelle session (Calendly sera recachÃ© par newSession)
    player.addEventListener("play", async () => {
      if (!ended) return;
      try { const t = await player.currentTime; if (t < 1) newSession(true); } catch(_){}
    });
  </script>
</body>
</html>
