<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vidéo personnalisée</title>
  <style>
    :root { color-scheme: light dark; }
    html, body { height:100%; margin:0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
           line-height:1.4; display:grid; place-items:start center; padding:16px;
           background: Canvas; color: CanvasText; }
    .wrap { width:min(900px,100%); }
    h1 { margin:0 0 8px; font-size:1.25rem; }
    .meta { font-size:.95rem; opacity:.8; margin-bottom:12px; }
    .notice { font-size:.95rem; background: color-mix(in srgb, CanvasText 8%, Canvas);
              border:1px solid color-mix(in srgb, CanvasText 18%, Canvas);
              padding:10px; border-radius:8px; margin:12px 0; }
    .err { color:#b00020; font-weight:600; }
    .video-box { width:100%; aspect-ratio:16/9; background:#000; border-radius:12px; overflow:hidden; }
    iframe, .video-box>* { width:100%; height:100%; border:0; display:block; }
    .help, .diag { font-size:.9rem; opacity:.85; margin-top:10px; }
    code { white-space:nowrap; }
    details { margin-top:10px; }
  </style>

  <!-- Préconnect utiles -->
  <link rel="dns-prefetch" href="https://iframe.cloudflarestream.com">
  <link rel="preconnect" href="https://iframe.cloudflarestream.com" crossorigin>
  <link rel="dns-prefetch" href="https://video.aqisio.com">
  <link rel="preconnect" href="https://video.aqisio.com" crossorigin>

  <!-- CSP permissive pour l’embed Cloudflare -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 img-src 'self' data:;
                 style-src 'self' 'unsafe-inline';
                 script-src 'self';
                 frame-src https://iframe.cloudflarestream.com https://video.aqisio.com;
                 connect-src 'self';
                 base-uri 'none';
                 form-action 'none'">
</head>
<body>
  <main class="wrap">
    <h1 id="title">Votre vidéo personnalisée</h1>
    <div id="meta" class="meta"></div>
    <div id="alerts"></div>

    <div id="player" class="video-box" aria-label="Lecteur vidéo Cloudflare Stream"></div>

    <p class="help">
      Paramètres attendus : <code>?f=Prénom&amp;l=Nom&amp;id=VIDEO_UID&amp;d=YYYY-MM-DD</code> (+ optionnel <code>cf=custom|global</code>).
      Exemple : <code>https://video.aqisio.com/?f=Cyril&amp;l=GUERRY&amp;id=0bf4f564089a51d49d457a4ce0b6fede&amp;d=2025-01-01</code>
    </p>

    <details>
      <summary>Diagnostic / Liens d’embed testables</summary>
      <div id="diag" class="diag"></div>
    </details>

    <noscript><p class="notice err">JavaScript est requis pour initialiser le lecteur Cloudflare Stream.</p></noscript>
  </main>

  <script>
    // ========= PARAMS / UTIL =========
    const qs = new URLSearchParams(location.search);
    const get = k => (qs.get(k) || "").trim();
    const esc = s => s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    const isValidId = id => /^[a-f0-9]{32}$|^[a-f0-9-]{36}$/i.test(id); // UID Stream courant (32 hex ou UUID v4)
    const isValidISODate = d => /^\d{4}-\d{2}-\d{2}$/.test(d);

    const f = get('f'), l = get('l'), id = get('id'), d = get('d');
    const cfMode = (get('cf').toLowerCase()); // "", "custom" ou "global"

    const $title = document.getElementById('title');
    const $meta  = document.getElementById('meta');
    const $alerts= document.getElementById('alerts');
    const $player= document.getElementById('player');
    const $diag  = document.getElementById('diag');

    const fullName = [f, l].filter(Boolean).join(' ').trim();
    if (fullName) { document.title = `Vidéo personnalisée pour ${fullName}`; $title.textContent = `Votre vidéo personnalisée, ${fullName}`; }
    const meta = [];
    if (fullName) meta.push(`Destinataire : ${esc(fullName)}`);
    if (d && isValidISODate(d)) meta.push(`Date prévue : ${esc(d)}`);
    if (cfMode) meta.push(`Mode forcé : ${esc(cfMode)}`);
    if (meta.length) $meta.innerHTML = meta.map(esc).join(' · ');

    // ========= CONTRÔLES =========
    const issues = [];
    if (!id) issues.push("Paramètre manquant : <code>id</code> (UID vidéo Cloudflare Stream).");
    if (id && !isValidId(id)) issues.push("Format d’<code>id</code> inattendu — vérifie que c’est bien le <strong>UID Stream</strong> (pas un ID interne).");

    if (issues.length) {
      $alerts.innerHTML = `<div class="notice err">${issues.join("<br>")}</div>`;
    } else {
      // ========= CONSTRUCTION DES URLS D'EMBED =========
      // NB Cloudflare :
      // - Domaine global :      https://iframe.cloudflarestream.com/{UID}
      // - Custom domain Stream: https://<ton-domaine>/{UID}/iframe
      const urls = {
        custom: `https://video.aqisio.com/${encodeURIComponent(id)}/iframe`,
        global: `https://iframe.cloudflarestream.com/${encodeURIComponent(id)}`
      };
      // Params light côté player (peu d’IO initial)
      const params = new URLSearchParams({ controls: '1', preload: 'metadata' });
      const makeSrc = (u) => `${u}?${params.toString()}`;

      // Choix du mode :
      // - si cf=custom|global est fourni → on respecte
      // - sinon, heuristique : si la page tourne sur video.aqisio.com, on essaie d’abord custom, sinon global
      const sameHostLooksCustom = location.hostname === 'video.aqisio.com';
      const order = (cfMode === 'custom') ? ['custom']
                  : (cfMode === 'global') ? ['global']
                  : (sameHostLooksCustom ? ['custom','global'] : ['global','custom']);

      // ========= INSERTION IFRAME + FALLBACK =========
      // Stratégie simple : on tente la 1ère URL ; si échec perçu (timeout d’affichage),
      // on propose l’autre URL dans la section Diagnostic (clic manuel).
      const firstSrc = makeSrc(urls[order[0]]);
      const secondSrc = order[1] ? makeSrc(urls[order[1]]) : null;

      const iframe = document.createElement('iframe');
      iframe.src = firstSrc;
      iframe.allow = "accelerometer; autoplay; encrypted-media; picture-in-picture; fullscreen";
      iframe.setAttribute('allowfullscreen', 'true');
      iframe.setAttribute('title', fullName ? `Vidéo pour ${fullName}` : 'Vidéo personnalisée');
      iframe.loading = "eager";
      $player.replaceChildren(iframe);

      // Prépare le diag (liens cliquables, très utile si l’UID est faux vs pb d’intégration)
      $diag.innerHTML =
        `<div class="notice">
           <div><strong>URL testée #1 (${esc(order[0])}) :</strong> <a href="${esc(firstSrc)}" target="_blank" rel="noopener">ouvrir l’iframe seule</a></div>
           ${secondSrc ? `<div><strong>URL testée #2 (${esc(order[1])}) :</strong> <a href="${esc(secondSrc)}" target="_blank" rel="noopener">ouvrir l’iframe seule</a></div>` : ``}
           <div style="margin-top:6px; font-size:.9em; opacity:.9">
             Si la vidéo s’ouvre en lien direct mais pas ici, c’est souvent un souci de <em>mode d’embed</em> ou de <em>CSP</em>.<br>
             Si elle ne s’ouvre nulle part, l’<code>id</code> ne correspond probablement pas au <strong>UID Cloudflare Stream</strong> ou la lecture requiert un <strong>token signé</strong>.
           </div>
         </div>`;

      // Affiche un message doux si au bout de quelques secondes l’iframe n’a pas peint (symptôme fréquent en 404/token manquant)
      setTimeout(() => {
        // Impossible de lire l’état interne de l’iframe cross-origin ; on affiche un rappel d’aide générique.
        // On n’écrase pas l’iframe, on ajoute juste un message.
        if (!$alerts.innerHTML) {
          $alerts.innerHTML =
            `<div class="notice">
               Si rien n’apparaît :
               <ul style="margin:6px 0 0 18px">
                 <li>Vérifie que <code>id</code> est bien le <strong>UID Stream</strong> (et non un ID interne).</li>
                 <li>Essaie d’ajouter <code>&cf=global</code> ou <code>&cf=custom</code> à l’URL pour forcer le mode d’embed.</li>
                 <li>Si Stream utilise des <strong>URL signées</strong>, il faut append <code>?token=&lt;JWT&gt;</code> (ce token doit être émis côté serveur).</li>
               </ul>
             </div>`;
        }
      }, 1800);
    }
  </script>
</body>
</html>
