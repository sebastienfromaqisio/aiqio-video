<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Regardez la Vidéo — Aqisio</title>

  <!-- Perf hints -->
  <link rel="preconnect" href="https://videodelivery.net" crossorigin>
  <link rel="preconnect" href="https://unpkg.com" crossorigin>

  <!-- Video.js -->
  <link href="https://unpkg.com/video.js@8/dist/video-js.css" rel="stylesheet">
  <script defer src="https://unpkg.com/video.js@8/dist/video.min.js"></script>
  <!-- hls.js (fallback quand HLS n’est pas natif) -->
  <script defer src="https://unpkg.com/hls.js@1.5.13/dist/hls.min.js"></script>

  <style>
    :root { color-scheme: dark; }
    body{ margin:0; background:#0b0b0b; color:#fff; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
    .wrap{ min-height:100dvh; display:grid; place-items:center; padding:16px; }
    .box{ width:min(1200px,100%); }
    .video-js{ width:100%; aspect-ratio:16/9; background:#000; border-radius:12px; overflow:hidden; }

    /* Sous-titres natifs en BLEU */
    .video-js video::cue, video::cue{
      color:#fff;
      background:#1a73e8;
      font-weight:600;
      line-height:1.35;
      padding:0.15em 0.4em;
      border-radius:0.6em;
      text-shadow:none;
    }

    .error{
      max-width:680px; margin:20vh auto; text-align:center; line-height:1.5;
      background:#141414; padding:24px; border-radius:12px; border:1px solid #262626;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="box">
      <div id="err" class="error" style="display:none">
        Lien invalide ou incomplet.<br>
        Paramètres requis : <code>?id=&lt;video_id_cloudflare&gt;</code> (et idéalement <code>&amp;f=</code>, <code>&amp;l=</code>).
      </div>

      <video id="aqisioPlayer" class="video-js vjs-default-skin" controls playsinline preload="metadata">
        <!-- sources et track injectés dynamiquement -->
      </video>
    </div>
  </div>

  <script>
    // === CONFIG ===
    // Base par défaut pour récupérer le .vtt : on suppose que le fichier est nommé <VIDEO_ID>.vtt
    // Exemple: https://pub-90311ed7….r2.dev/subs/<VIDEO_ID>.vtt
    const VTT_BASE = "https://pub-90311ed7327a4e34ac43f12b99543fd9.r2.dev/subs";

    // === PARAMS URL ===
    const q = new URLSearchParams(location.search);
    const videoId = (q.get('id') || '').trim();
    const first = q.get('f') || '';
    const last  = q.get('l') || '';
    const vttOverride = q.get('vtt'); // facultatif: URL complète vers un .vtt

    // Si pas d'ID => pas de page par défaut
    if (!videoId) {
      document.getElementById('err').style.display = 'block';
    }

    const player = videojs('aqisioPlayer', { controls:true, preload:'metadata' });

    player.ready(() => {
      if (!videoId) return;

      const src = `https://videodelivery.net/${encodeURIComponent(videoId)}/manifest/video.m3u8`;
      // Balise <source>
      const sourceEl = document.createElement('source');
      sourceEl.src = src;
      sourceEl.type = "application/x-mpegURL";
      player.el().querySelector('video').appendChild(sourceEl);

      // Balise <track> (VTT)
      const vttUrl = vttOverride ? decodeURIComponent(vttOverride) : `${VTT_BASE}/${encodeURIComponent(videoId)}.vtt`;
      const trackEl = document.createElement('track');
      trackEl.kind = "subtitles";
      trackEl.srclang = "fr";
      trackEl.label = "Français";
      trackEl.src = vttUrl;
      trackEl.default = true;
      player.el().querySelector('video').appendChild(trackEl);

      // Activer l'affichage natif des ST
      player.one('loadedmetadata', () => {
        const videoEl = player.tech().el();
        for (const tt of videoEl.textTracks) {
          if (tt.kind === 'subtitles') tt.mode = 'showing';
        }
      });

      // Fallback hls.js si pas de HLS natif
      const tech = player.tech(true);
      const needHls = tech && !tech.featuresNativeHls;
      if (needHls && window.Hls && window.Hls.isSupported()) {
        const video = tech.el();
        const hls = new Hls();
        hls.loadSource(src);
        hls.attachMedia(video);
      }
    });

    // (Optionnel) Personnaliser le titre de page pour le prospect
    if (first || last) {
      document.title = `${first ? first : ''} ${last ? last : ''} - Regardez la Vidéo`.trim();
    }
  </script>
</body>
</html>
